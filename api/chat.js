// ملف: api/chat.js
export default async function handler(req, res) {
  // تمكين CORS
  res.setHeader('Access-Control-Allow-Credentials', true);
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT');
  res.setHeader('Access-Control-Allow-Headers', 'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version');
  
  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }
  
  if (req.method === 'POST') {
    try {
      const { message } = req.body;
      
      console.log('📨 Received message:', message);
  
      if (!message) {
        return res.status(400).json({ response: 'الرسالة فارغة' });
      }
  
      // العودة إلى استخدام API متوافق مع OpenAI مع المفتاح الجديد
      const response = await fetch('https://api.deepseek.com/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer sk-24271c1ea6b74742bd31ec540f5c5fa6', // المفتاح الجديد
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: "deepseek-chat",
          messages: [
            {
              role: "system",
              content: `أنت مساعد طبي في مجمع عيادات عربي. أجب على أي سؤال باللغة العربية بطريقة مفيدة وودودة. ساعد في معلومات طبية عامة، توجيه للعيادات، نصائح صحية.`
            },
            {
              role: "user",
              content: message
            }
          ],
          max_tokens: 500,
          temperature: 0.7
        })
      });
  
      console.log('🔧 API Response status:', response.status);
  
      if (response.ok) {
        const data = await response.json();
        console.log('✅ API Success:', data);

        let botResponse = data.choices[0]?.message?.content || '';

        if (!botResponse || botResponse.length < 5) {
          botResponse = getSmartResponse(message);
        }
        
        res.status(200).json({ response: botResponse });
      } else {
        // إذا فشل، استخدم الردود الذكية
        const smartResponse = getSmartResponse(message);
        res.status(200).json({ response: smartResponse });
      }
      
    } catch (error) {
      console.error('💥 Catch Error:', error);
      const smartResponse = getSmartResponse(req.body?.message || '');
      res.status(200).json({ response: smartResponse });
    }
  } else {
    res.setHeader('Allow', ['POST']);
    res.status(405).end(`Method ${req.method} Not Allowed`);
  }
}
  
// نظام ردود ذكي ومتطور
function getSmartResponse(message) {
  const lowerMessage = message.toLowerCase().trim();
  
  const responses = {
    'مرحبا': 'مرحباً بك! 🌟 أنا المساعد الافتراضي لمجمع العيادات. أسألني عن أي شيء: العيادات، الخدمات، حجز المواعيد، أو استفسارات طبية عامة.',
    
    'اهلا': 'أهلاً وسهلاً! 😊 أنا هنا لمساعدتك في أي استفسار طبي. كيف يمكنني خدمتك اليوم؟',
    
    'السلام عليكم': 'وعليكم السلام ورحمة الله وبركاته! 🙏 كيف يمكنني مساعدتك اليوم؟',

    'كيف حالك': 'الحمد لله بخير! 🌸 سعيد لخدمتك. كيف يمكنني مساعدتك في مجمع العيادات؟',

    'من انت': 'أنا المساعد الافتراضي لمجمع العيادات! 🤖 مهمتي مساعدتك في الاستفسارات الطبية، معلومات العيادات، حجز المواعيد، والنصائح الصحية.',

    'شكرا': 'العفو! 🌟 دائماً سعيد بمساعدتك. هل لديك أي أسئلة أخرى؟',

    'عيادات': `🏥 **عياداتنا المتخصصة:**

• 🦷 **عيادة الأسنان**
  - تنظيف وفحص دوري
  - حشوات تجميلية
  - تبييض الأسنان
  - تقويم الأسنان
  - علاج الجذور
  - زراعة الأسنان

• 👶 **عيادة الأطفال**
  - فحوصات النمو والتطور
  - التطعيمات الأساسية
  - علاج الأمراض الشائعة
  - استشارات الرضاعة
  - متابعة حديثي الولادة

• 🩺 **عيادة الجلدية**
  - علاج حب الشباب
  - الأمراض الجلدية
  - العناية بالبشرة
  - إزالة الشامات
  - علاج تساقط الشعر

• ❤️ **عيادة الباطنة**
  - أمراض القلب
  - أمراض السكري
  - ضغط الدم
  - الأمراض الداخلية

• 👁️ **عيادة العيون**
  - فحوصات النظر
  - علاج أمراض العيون
  - عمليات الليزك

أي عيادة تريد معرفة المزيد عنها؟`,

    'اسنان': `🦷 **عيادة الأسنان - خدمات متكاملة:**

**الخدمات المتوفرة:**
✓ تنظيف وفحص دوري
✓ حشوات تجميلية بلون الأسنان
✓ تبييض الأسنان بالليزر
✓ تقويم الأسنان للكبار والصغار
✓ علاج قناة الجذر
✓ زراعة الأسنان
✓ خلع الأسنان

**طاقم العمل:**
👨‍⚕️ د. أحمد محمد - اختصاصي طب الأسنان
👩‍⚕️ د. سلمى عبدالله - اختصاصية تجميل الأسنان

**مواعيد العمل:**
🕐 من السبت إلى الخميس
⏰ 9:00 صباحاً - 9:00 مساءً

📞 للحجز: 966123456789`,

    'اطفال': `👶 **عيادة الأطفال - رعاية شاملة:**

**الخدمات المتوفرة:**
✓ فحوصات النمو والتطور
✓ التطعيمات حسب جدول وزارة الصحة
✓ علاج الأمراض الشائعة (نزلات البرد، الالتهابات)
✓ استشارات الرضاعة الطبيعية
✓ متابعة حديثي الولادة
✓ فحوصات ما قبل المدرسة

**طاقم العمل:**
👩‍⚕️ د. سارة علي - اختصاصية طب الأطفال
👨‍⚕️ د. محمد حسن - استشاري أمراض الأطفال

**نصائح للأمهات:**
• الرضاعة الطبيعية لمدة 6 أشهر
• التطعيمات في مواعيدها
• النوم الكافي للطفل
• الغذاء الصحي المتوازن

📞 للاستفسار: 966123456789`,

    'جلدية': `🩺 **عيادة الجلدية - عناية شاملة:**

**الخدمات المتوفرة:**
✓ علاج حب الشباب بأنواعه
✓ الأمراض الجلدية المزمنة (الصدفية، الإكزيما)
✓ العناية بالبشرة والتجميل
✓ إزالة الشامات والزوائد الجلدية
✓ علاج تساقط الشعر
✓ تشخيص الأمراض الجلدية

**طاقم العمل:**
👨‍⚕️ د. خالد أحمد - استشاري الأمراض الجلدية
👩‍⚕️ د. منى سعيد - اختصاصية العناية بالبشرة

**نصائح للبشرة:**
• استخدم واقي شمس يومياً
• نظف بشرتك مرتين يومياً
• اشرب 8 أكواب ماء
• تناول غذاء غني بالفيتامينات

🕐 المواعيد: الأحد - الخميس (10 صباحاً - 8 مساءً)`,

    'حجز': `📅 **حجز الموعد - طرق متعددة:**

**الطرق المتاحة:**
1. 📞 **هاتفياً**
   - الرقم: 966123456789
   - متاح من 8 صباحاً حتى 10 مساءً

2. 🌐 **أونلاين**
   - املأ نموذج الحجز في الموقع
   - سنتواصل معك خلال 24 ساعة

3. 📱 **واتساب**
   - أرسل رسالة على: 966123456789
   - اذكر اسمك والعيادة المطلوبة

4. 🏥 **حضورياً**
   - تفضل بزيارتنا في العيادة
   - مواقف مجانية للسيارات

**معلومات الحجز:**
• يرجى الحضور قبل 15 دقيقة من الموعد
• إحضار الهوية الوطنية
• إحضار التقارير الطبية السابقة إن وجدت

أي عيادة تريد الحجز فيها؟`,

    'موعد': `🕐 **مواعيد العمل الرسمية:**

**الأيام والأوقات:**
• 🗓️ **الأحد - الخميس**
  ⏰ 8:00 صباحاً - 10:00 مساءً

• 🗓️ **الجمعة**
  ⏰ 4:00 مساءً - 10:00 مساءً

• 🗓️ **السبت**
  ⏰ 9:00 صباحاً - 6:00 مساءً

**العيادات المتاحة:**
• عيادة الأسنان: 9:00 ص - 9:00 م
• عيادة الأطفال: 10:00 ص - 8:00 م  
• عيادة الجلدية: 11:00 ص - 7:00 م
• عيادة الباطنة: 8:00 ص - 6:00 م
• عيادة العيون: 9:00 ص - 5:00 م

📞 للاستفسار عن موعد محدد: 966123456789`,

    'رقم': `📞 **معلومات الاتصال:**

**أرقام الهاتف:**
• ☎️ **الهاتف الرئيسي**: 966123456789
• 📱 **الواتساب**: 966123456789
• 🚨 **الطوارئ**: 966123456789 (24/7)

**البريد الإلكتروني:**
• 📧 info@clinic.com

**وسائل التواصل الاجتماعي:**
• 📘 فيسبوك: /MedicalClinic
• 🐦 تويتر: @MedicalClinic
• 📸 انستغرام: @MedicalClinic

**العنوان:**
📍 مجمع عيادات [اسم المجمع]
الرياض - حي العليا - شارع الملك فهد

**مواقف السيارات:**
🅿️ مواقف مجانية ومغطاة`,

    'عنوان': `📍 **العنوان والموقع:**

**العنوان التفصيلي:**
مجمع عيادات [اسم المجمع]
الرياض - حي العليا
شارع الملك فهد
(بجوار مركز commercial)

**الوصول إلينا:**
• 🗺️ **بالسيارة**: مواقف مجانية في المبنى
• 🚌 **بالمواصلات**: موقف باصات قريب
• 🚕 **بالتكسي**: استخدم تطبيقات التوصيل

**الخدمات المتاحة:**
✓ مواقف مجانية للسيارات
✓ مداخل لمستخدمي الكراسي المتحركة
✓ مصاعد كهربائية
✓ خدمة الاستقبال والاستعلامات
✓ صيدلية داخلية

**ساعات الزيارة:**
🕐 8:00 صباحاً - 10:00 مساءً (جميع الأيام)`,

    'سعر': `💵 **الأسعار والدفع:**

**بخصوص الأسعار:**
• الأسعار تختلف حسب الخدمة والعيادة
• لدينا باقات وعروض خاصة دورياً
• خصومات للكشف الدوري
• عروض للعائلات والكشف المجمع

**طرق الدفع المتاحة:**
• 💳 بطاقات الائتمان والمدى
• 📱 الدفع الإلكتروني
• 💰 الدفع النقدي
• 📊 التقسيط (للبعض الخدمات)

**الشروط:**
• الأسعار تشمل الكشف فقط (ما لم يذكر غير ذلك)
• الخدمات الإضافية أسعارها منفصلة
• يفضل الحجز المسبق للاطلاع على الأسعار

📞 للاستفسار عن الأسعار: 966123456789`,

    'طوارئ': `🚨 **الحالات الطارئة:**

**للحالات الطارئة:**
• 📞 **هاتف الطوارئ**: 966123456789 (24/7)
• 🏥 **الحضور المباشر**: تفضل بالحضور فوراً
• 🚑 **الإسعاف**: اتصل على 997 للحالات الحرجة

**الحالات التي نستقبلها:**
✓ الإصابات والحوادث
✓ الآلام الحادة والمفاجئة
✓ ارتفاع الحرارة الشديد
✓ صعوبة التنفس
✓ النزيف الحاد
✓ الحروق

**طاقم الطوارئ:**
• أطباء متاحون 24 ساعة
• ممرضون متخصصون
• غرف عناية مركزة
• أجهزة متطورة

**نصائح للطوارئ:**
• احفظ أرقام الطوارئ
• كن هادئاً وواضحاً في الشرح
• أحضر أي أدوية يتناولها المريض
• أحضر التقارير الطبية السابقة`,

    'نصيحة': `💡 **نصائح طبية عامة:**

**للصحة العامة:**
• 💧 اشرب 8 أكواب ماء يومياً
• 🏃‍♂️ مارس الرياضة 30 دقيقة يومياً
• 🥗 تناول 5 حصص من الخضار والفواكه
• 😴 نم 7-8 ساعات ليلاً
• 🚭 تجنب التدخين والمشروبات الغازية

**للوقاية من الأمراض:**
• اغسل يديك بانتظام
• تجنب لمس الوجه
• حافظ على التباعد الاجتماعي
• تناول التطعيمات الدورية

**لصحة القلب:**
• قلل من الملح والدهون
• مارس المشي يومياً
• تحقق من ضغط الدم بانتظام
• تجنب التوتر والقلق

**لصحة العظام:**
• تناول الأطعمة الغنية بالكالسيوم
• تعرض لأشعة الشمس صباحاً
• مارس تمارين حمل الأوزان

هل تريد نصيحة محددة؟`,

    'صحة': `🌿 **نظام حياة صحي:**

**الفحوصات الدورية:**
• 📋 فحص شامل سنوياً
• ❤️ فحص القلب كل 6 أشهر
• 🦷 فحص الأسنان كل 6 أشهر
• 👁️ فحص العيون سنوياً
• 🩺 فحص الضغط والسكر شهرياً

**التطعيمات المهمة:**
• 💉 الإنفلونزا الموسمية
• 💉 التيتانوس كل 10 سنوات
• 💉 الالتهاب الرئوي
• 💉 فيروس الورم الحليمي

**العادات الصحية:**
• 🌅 استيقظ مبكراً
• ☀️ تعرض للشمس صباحاً
• 🧘‍♂️ مارس التأمل واليوجا
• 📵 قلل وقت الشاشات
• 📚 اقرأ يومياً

**التغذية الصحية:**
• 🍎 تفاحة يومياً
• 🥦 خضروات خضراء
• 🐟 أسماك مرتين أسبوعياً
• 🥛 حليب ومشتقاته
• 🌾 حبوب كاملة

العقل السليم في الجسم السليم! 🧠💪`,

    'ممتاز': `شكراً لك! 😊 هذا يشجعنا على تقديم الأفضل.

هل هناك شيء آخر تريد معرفته؟
🏥 العيادات والخدمات
📅 حجز المواعيد
📞 معلومات الاتصال
💊 نصائح طبية`,

    'default': `🤖 **مساعد العيادة الافتراضي**

أهلاً بك! 🌟 أنا هنا لمساعدتك في:

🏥 **معلومات العيادات** - اسأل عن عيادة محددة
📅 **حجز المواعيد** - كيفية الحجز والتواصل
📞 **الاتصال بنا** - أرقام وعناوين
💊 **الخدمات الطبية** - الخدمات المتوفرة
🌿 **نصائح طبية** - استفسارات صحية عامة
🚨 **الحالات الطارئة** - معلومات الطوارئ

💡 **أمثلة للأسئلة:**
• "ما هي العيادات المتوفرة؟"
• "أريد حجز موعد في عيادة الأسنان"
• "ما هي ساعات العمل؟"
• "أعطني نصائح للصحة"

📞 **للأسئلة العاجلة: اتصل بنا على 966123456789**

كيف يمكنني مساعدتك؟`
  };

  // بحث متقدم في الردود
  for (const [keyword, response] of Object.entries(responses)) {
    if (lowerMessage.includes(keyword)) {
      return response;
    }
  }

  // إذا كان سؤال عن عيادة محددة
  if (lowerMessage.includes('اسنان') || lowerMessage.includes('سن') || lowerMessage.includes('ضرس') || lowerMessage.includes('فم')) {
    return responses['اسنان'];
  }
  
  if (lowerMessage.includes('اطفال') || lowerMessage.includes('طفل') || lowerMessage.includes('رضيع') || lowerMessage.includes('وليد')) {
    return responses['اطفال'];
  }
  
  if (lowerMessage.includes('جلد') || lowerMessage.includes('بشرة') || lowerMessage.includes('شعر') || lowerMessage.includes('حب شباب')) {
    return responses['جلدية'];
  }

  if (lowerMessage.includes('باطنة') || lowerMessage.includes('قلب') || lowerMessage.includes('ضغط') || lowerMessage.includes('سكر')) {
    return responses['عيادات'] + '\n\n❤️ **للاستفسارات عن عيادة الباطنة: اتصل على 966123456789**';
  }

  if (lowerMessage.includes('عيون') || lowerMessage.includes('نظر') || lowerMessage.includes('عين')) {
    return responses['عيادات'] + '\n\n👁️ **للاستفسارات عن عيادة العيون: اتصل على 966123456789**';
  }

  if (lowerMessage.includes('عمل') || lowerMessage.includes('وقت') || lowerMessage.includes('ساعة') || lowerMessage.includes('يفتح') || lowerMessage.includes('يغلق')) {
    return responses['موعد'];
  }

  if (lowerMessage.includes('كم') || lowerMessage.includes('سعر') || lowerMessage.includes('ثمن') || lowerMessage.includes('كلفة')) {
    return responses['سعر'];
  }

  if (lowerMessage.includes('ين') || lowerMessage.includes('اين') || lowerMessage.includes('موقع') || lowerMessage.includes('عنوان') || lowerMessage.includes('مكان')) {
    return responses['عنوان'];
  }

  if (lowerMessage.includes('اتصل') || lowerMessage.includes('رقم') || lowerMessage.includes('هاتف') || lowerMessage.includes('تلفون') || lowerMessage.includes('موبايل')) {
    return responses['رقم'];
  }

  // إذا كان سؤال طبي
  const medicalWords = ['وجع', 'ألم', 'مرض', 'علاج', 'دواء', 'فحص', 'تحليل', 'جراحة', 'عملية', 'diagnosis', 'علاج', 'عليل', 'مريض', 'صحه', 'صحة', 'دكتور', 'طبيب'];
  for (const word of medicalWords) {
    if (lowerMessage.includes(word)) {
      return `🩺 **بخصوص سؤالك الطبي:**

هذا يحتاج استشارة طبية متخصصة. ننصحك ب:

• 🏥 **زيارة العيادة** للفحص الدقيق
• 📞 **الاتصال بنا** على 966123456789
• 📅 **حجز موعد** للاستشارة

💡 **للأسئلة العاجلة: الطوارئ متاحة 24/7**

أي عيادة تظن أنها مناسبة لحالتك؟`;
    }
  }

  return responses['default'];
}
