// ููู: api/chat.js
export default async function handler(req, res) {
  // ุชูููู CORS
  res.setHeader('Access-Control-Allow-Credentials', true);
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT');
  res.setHeader('Access-Control-Allow-Headers', 'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version');

  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }

  if (req.method === 'POST') {
    try {
      const { message } = req.body;
      
      console.log('๐จ Received message:', message);

      // ุชุญูู ูู ูุฌูุฏ ุงูุฑุณุงูุฉ
      if (!message) {
        return res.status(400).json({ response: 'ุงูุฑุณุงูุฉ ูุงุฑุบุฉ' });
      }

      // ๐ก ููุงุญุธุฉ ุฃูููุฉ: ูู ุงูุฃูุถู ุชุฎุฒูู ููุชุงุญ ุงูู API ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ
      // const apiKey = process.env.OPENAI_API_KEY;
      const apiKey = 'sk-36f114d6582e4c7a8cd3d2c7fb998d53'; // ุงูููุชุงุญ ุงูุญุงูู ููุชุฌุฑุจุฉ

      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [
            {
              role: "system",
              content: `ุฃูุช ูุณุงุนุฏ ุทุจู ูู ูุฌูุน ุนูุงุฏุงุช ุนุฑุจู. 
ุณุงุนุฏ ูู ูุนูููุงุช ุทุจูุฉ ุนุงูุฉุ ุชูุฌูู ููุนูุงุฏุงุชุ ูุตุงุฆุญ ุตุญูุฉ.`
            },
            {
              role: "user",
              content: message
            }
          ],
          max_tokens: 500,
          temperature: 0.7
        })
      });

      console.log('๐ง API Response status:', response.status);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('โ API Error:', response.status, errorText);
        
        // ุงุณุชุฎุฏู ุฑุฏูุฏ ูุญููุฉ ุฅุฐุง ูุดู ุงูู API
        return res.status(200).json({ 
          response: getLocalResponse(message) 
        });
      }

      const data = await response.json();
      console.log('โ API Success:', data);
      
      const botResponse = data.choices[0]?.message?.content || 'ุดูุฑุงู ูุณุคุงูู!';

      res.status(200).json({ response: botResponse });
      
    } catch (error) {
      console.error('๐ฅ Catch Error:', error);
      
      // ุฏุงุฆูุงู ูุฑุฌุน 200 ูุน ุฑุฏ ูุญูู
      res.status(200).json({ 
        response: getLocalResponse(req.body?.message || '') 
      });
    }
  } else {
    res.setHeader('Allow', ['POST']);
    res.status(405).end(`Method ${req.method} Not Allowed`);
  }
}

// ูุธุงู ุฑุฏูุฏ ูุญูู ุฐูู
function getLocalResponse(message) {
  const lowerMessage = message.toLowerCase();
  
  const responses = {
    'ูุฑุญุจุง': 'ุฃููุงู ูุณููุงู! ๐ ุฃูุง ูุณุงุนุฏ ุงูุนูุงุฏุฉ ุงูุงูุชุฑุงุถู. ููู ูููููู ูุณุงุนุฏุชู ุงููููุ',
    'ุงููุง': 'ุฃููุงู ูุณููุงู! ๐ ุฃูุง ููุง ููุณุงุนุฏุชู ูู ุงุณุชูุณุงุฑุงุชู ุงูุทุจูุฉ.',
    'ุงูุณูุงู ุนูููู': 'ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู! ๐ ููู ูููููู ุฎุฏูุชูุ',
    
    'ุนูุงุฏุงุช': `๐ฅ **ุนูุงุฏุงุชูุง ุงููุชููุฑุฉ:**
โข ๐ฆท ุนูุงุฏุฉ ุงูุฃุณูุงู - ุนูุงุฌุงุช ูุชูุงููุฉ
โข ๐ถ ุนูุงุฏุฉ ุงูุฃุทูุงู - ุฑุนุงูุฉ ุดุงููุฉ  
โข ๐ฉบ ุนูุงุฏุฉ ุงูุฌูุฏูุฉ - ุนูุงูุฉ ุจุงูุจุดุฑุฉ
โข โค๏ธ ุนูุงุฏุฉ ุงูุจุงุทูุฉ - ุฃูุฑุงุถ ุฏุงุฎููุฉ
โข ๐๏ธ ุนูุงุฏุฉ ุงูุนููู - ูุญูุตุงุช ูุชูุฏูุฉ

ุฃู ุนูุงุฏุฉ ุชุฑูุฏ ูุนุฑูุฉ ุงููุฒูุฏ ุนููุงุ`,

    'ุงุณูุงู': `๐ฆท **ุนูุงุฏุฉ ุงูุฃุณูุงู:**
โข ุชูุธูู ููุญุต ุฏูุฑู
โข ุญุดูุงุช ุชุฌููููุฉ  
โข ุชุจููุถ ุงูุฃุณูุงู
โข ุชูููู ุงูุฃุณูุงู
โข ุนูุงุฌ ุงูุฌุฐูุฑ

๐ ููุญุฌุฒ: 966123456789`,

    'ุงุทูุงู': `๐ถ **ุนูุงุฏุฉ ุงูุฃุทูุงู:**
โข ูุญูุตุงุช ุงูููู
โข ุงูุชุทุนููุงุช ุงูุฃุณุงุณูุฉ
โข ุนูุงุฌ ุงูุฃูุฑุงุถ ุงูุดุงุฆุนุฉ
โข ุงุณุชุดุงุฑุงุช ุงูุชุบุฐูุฉ

๐ ูุชุงุญ ูู 8 ุตุจุงุญุงู ุญุชู 8 ูุณุงุกู`,

    'ุญุฌุฒ': `๐ **ูุญุฌุฒ ููุนุฏ:**
1. ๐ ูุงุชููุงู: 966123456789
2. ๐ ุฃูููุงูู: ุงููุฃ ูููุฐุฌ ุงูุญุฌุฑ
3. ๐ฅ ุญุถูุฑูุงู: ุชูุถู ุจุฒูุงุฑุชูุง

ุฃู ุนูุงุฏุฉ ุชุฑูุฏ ุงูุญุฌุฒ ูููุงุ`,

    'ุฑูู': `๐ **ุงุชุตู ุจูุง:**
โข ุงููุงุชู: 966123456789
โข ุงููุงุชุณุงุจ: 966123456789  
โข ุงูุทูุงุฑุฆ: 966123456789

โฐ ูุชุงุญูู 24/7 ููุทูุงุฑุฆ`,

    'ุนููุงู': `๐ **ุนููุงู ุงููุฌูุน:**
ูุฌูุน ุนูุงุฏุงุช [ุงุณู ุงููุฌูุน]
ุงูุฑูุงุถ - ุญู ุงูุนููุง - ุดุงุฑุน ุงูููู ููุฏ

๐บ๏ธ ููุงูู ูุฌุงููุฉ - ุณูููุฉ ุงููุตูู`,

    'ุทูุงุฑุฆ': `๐จ **ููุญุงูุงุช ุงูุทุงุฑุฆุฉ:**
โข ูุงุชู ุงูุทูุงุฑุฆ: 966123456789 (24/7)
โข ุฏุงุฎู ุฃููุงุช ุงูุนูู: ุชูุถู ุจุงูุญุถูุฑ ููุฑุงู
โข ููุญุงูุงุช ุงูุญุฑุฌุฉ: ุชูุฌู ูุฃูุฑุจ ูุณุชุดูู`,

    'default': `๐ค **ูุณุงุนุฏ ุงูุนูุงุฏุฉ ุงูุงูุชุฑุงุถู**

ุฃููุงู ุจู! ููุฃุณู ุงูุฎุฏูุฉ ุงูุฐููุฉ ุบูุฑ ูุชุงุญุฉ ุญุงููุงู.

ููู ูููููู ูุณุงุนุฏุชู ูู:
๐ฅ ูุนูููุงุช ุงูุนูุงุฏุงุช
๐ ุญุฌุฒ ุงูููุงุนูุฏ  
๐ ุงูุงุชุตุงู ุจูุง
๐ ูุตุงุฆุญ ุทุจูุฉ ุนุงูุฉ

๐ **ุงุชุตู ุจูุง ุนูู: 966123456789**`
  };

  // ุงูุจุญุซ ุนู ุฃูุถู ุฑุฏ
  for (const [keyword, response] of Object.entries(responses)) {
    if (lowerMessage.includes(keyword)) {
      return response;
    }
  }

  return responses['default'];
}

// ูุธุงู ุฑุฏูุฏ ูุญูู ุฐูู ูุญู ุงุญุชูุงุทู
function getLocalResponse(message) {
  const lowerMessage = message.toLowerCase().trim();
  
  const responses = {
    'ูุฑุญุจุง': 'ุฃููุงู ูุณููุงู! ๐ ุฃูุง ูุณุงุนุฏ ุงูุนูุงุฏุฉ ุงูุงูุชุฑุงุถู. ููู ูููููู ูุณุงุนุฏุชู ุงููููุ',
    'ุงููุง': 'ุฃููุงู ูุณููุงู! ๐ ุฃูุง ููุง ููุณุงุนุฏุชู ูู ุงุณุชูุณุงุฑุงุชู ุงูุทุจูุฉ.',
    'ุงูุณูุงู ุนูููู': 'ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู! ๐ ููู ูููููู ุฎุฏูุชูุ',
    
    'ุนูุงุฏุงุช': `๐ฅ **ุนูุงุฏุงุชูุง ุงููุชููุฑุฉ:**
โข ๐ฆท ุนูุงุฏุฉ ุงูุฃุณูุงู - ุนูุงุฌุงุช ูุชูุงููุฉ
โข ๐ถ ุนูุงุฏุฉ ุงูุฃุทูุงู - ุฑุนุงูุฉ ุดุงููุฉ  
โข ๐ฉบ ุนูุงุฏุฉ ุงูุฌูุฏูุฉ - ุนูุงูุฉ ุจุงูุจุดุฑุฉ
โข โค๏ธ ุนูุงุฏุฉ ุงูุจุงุทูุฉ - ุฃูุฑุงุถ ุฏุงุฎููุฉ
โข ๐๏ธ ุนูุงุฏุฉ ุงูุนููู - ูุญูุตุงุช ูุชูุฏูุฉ

ุฃู ุนูุงุฏุฉ ุชุฑูุฏ ูุนุฑูุฉ ุงููุฒูุฏ ุนููุงุ`,

    'ุงุณูุงู': `๐ฆท **ุนูุงุฏุฉ ุงูุฃุณูุงู:**
โข ุชูุธูู ููุญุต ุฏูุฑู
โข ุญุดูุงุช ุชุฌููููุฉ  
โข ุชุจููุถ ุงูุฃุณูุงู
โข ุชูููู ุงูุฃุณูุงู
โข ุนูุงุฌ ุงูุฌุฐูุฑ

๐ ููุญุฌุฒ: 966123456789`,

    'ุงุทูุงู': `๐ถ **ุนูุงุฏุฉ ุงูุฃุทูุงู:**
โข ูุญูุตุงุช ุงูููู
โข ุงูุชุทุนููุงุช ุงูุฃุณุงุณูุฉ
โข ุนูุงุฌ ุงูุฃูุฑุงุถ ุงูุดุงุฆุนุฉ
โข ุงุณุชุดุงุฑุงุช ุงูุชุบุฐูุฉ

๐ ูุชุงุญ ูู 8 ุตุจุงุญุงู ุญุชู 8 ูุณุงุกู`,

    'ุญุฌุฒ': `๐ **ูุญุฌุฒ ููุนุฏ:**
1. ๐ ูุงุชููุงู: 966123456789
2. ๐ ุฃูููุงูู: ุงููุฃ ูููุฐุฌ ุงูุญุฌุฒ ุนูู ูููุนูุง
3. ๐ฅ ุญุถูุฑูุงู: ุชูุถู ุจุฒูุงุฑุชูุง

ุฃู ุนูุงุฏุฉ ุชุฑูุฏ ุงูุญุฌุฒ ูููุงุ`,

    'ุฑูู': `๐ **ุงุชุตู ุจูุง:**
โข ุงููุงุชู: 966123456789
โข ุงููุงุชุณุงุจ: 966123456789  
โข ุงูุทูุงุฑุฆ: 966123456789

โฐ ูุชุงุญูู 24/7 ููุทูุงุฑุฆ`,

    'ุนููุงู': `๐ **ุนููุงู ุงููุฌูุน:**
ูุฌูุน ุนูุงุฏุงุช [ุงุณู ุงููุฌูุน]
ุงูุฑูุงุถ - ุญู ุงูุนููุง - ุดุงุฑุน ุงูููู ููุฏ

๐บ๏ธ ููุงูู ูุฌุงููุฉ - ุณูููุฉ ุงููุตูู`,

    'ุทูุงุฑุฆ': `๐จ **ููุญุงูุงุช ุงูุทุงุฑุฆุฉ:**
โข ูุงุชู ุงูุทูุงุฑุฆ: 966123456789 (24/7)
โข ุฏุงุฎู ุฃููุงุช ุงูุนูู: ุชูุถู ุจุงูุญุถูุฑ ููุฑุงู
โข ููุญุงูุงุช ุงูุญุฑุฌุฉ: ุชูุฌู ูุฃูุฑุจ ูุณุชุดูู`,

    'default': `๐ค **ูุณุงุนุฏ ุงูุนูุงุฏุฉ ุงูุงูุชุฑุงุถู**

ุฃููุงู ุจู! ููุฃุณู ุงูุฎุฏูุฉ ุงูุฐููุฉ ุบูุฑ ูุชุงุญุฉ ุญุงููุงู.

ููู ูููููู ูุณุงุนุฏุชู ูู:
๐ฅ ูุนูููุงุช ุงูุนูุงุฏุงุช
๐ ุญุฌุฒ ุงูููุงุนูุฏ  
๐ ุงูุงุชุตุงู ุจูุง

๐ **ุงุชุตู ุจูุง ุนูู: 966123456789**`
  };

  // ุงูุจุญุซ ุนู ุฃูุถู ุฑุฏ
  for (const [keyword, response] of Object.entries(responses)) {
    if (lowerMessage.includes(keyword)) {
      return response;
    }
  }

  return responses['default'];
}
